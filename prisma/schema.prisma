generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ────────────────────────────────────────────────

enum ListingStatus {
  ACTIVE
  RESERVED
  SOLD
  HIDDEN
  DELETED
}

enum ListingCondition {
  NEW
  LIKE_NEW
  GOOD
  FAIR
  POOR
}

enum ListingCategory {
  ELECTRONICS
  FURNITURE
  CLOTHING
  BOOKS
  SPORTS
  TOYS
  HOME
  AUTO
  GARDEN
  MUSIC
  ART
  COLLECTIBLES
  FREE_STUFF
  OTHER
}

enum OfferStatus {
  PENDING
  ACCEPTED
  REJECTED
  COUNTERED
  CANCELLED
  EXPIRED
}

enum MessageType {
  TEXT
  IMAGE
  OFFER
  SYSTEM
}

enum CommunityType {
  NEIGHBORHOOD
  INTEREST
  SCHOOL
  WORKPLACE
}

enum CommunityRole {
  MEMBER
  MODERATOR
  ADMIN
}

enum NotificationType {
  NEW_MESSAGE
  NEW_OFFER
  OFFER_ACCEPTED
  OFFER_REJECTED
  OFFER_COUNTERED
  LISTING_LIKED
  REVIEW_RECEIVED
  COMMUNITY_UPDATE
  SYSTEM
}

enum DevicePlatform {
  IOS
  ANDROID
  WEB
}

enum VerifiedBadge {
  PHONE
  EMAIL
  GOOGLE
  APPLE
  ID_VERIFIED
}

// ─── Models ───────────────────────────────────────────────

model User {
  id             String          @id @default(cuid())
  phone          String?         @unique
  email          String?         @unique
  googleId       String?         @unique @map("google_id")
  appleId        String?         @unique @map("apple_id")
  displayName    String?         @map("display_name")
  username       String?         @unique
  avatarUrl      String?         @map("avatar_url")
  bio            String?
  neighborhood   String?
  city           String?
  state          String?
  mannerTemp     Float           @default(36.5) @map("manner_temp")
  verifiedBadges VerifiedBadge[] @map("verified_badges")
  isActive       Boolean         @default(true) @map("is_active")
  lastActiveAt   DateTime?       @map("last_active_at")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  // Relations
  listings           Listing[]          @relation("SellerListings")
  sentOffers         Offer[]            @relation("BuyerOffers")
  receivedOffers     Offer[]            @relation("SellerOffers")
  buyerConversations Conversation[]     @relation("BuyerConversations")
  sellerConversations Conversation[]    @relation("SellerConversations")
  messages           Message[]
  communityMembers   CommunityMember[]
  likes              Like[]
  reviewsGiven       Review[]           @relation("ReviewerReviews")
  reviewsReceived    Review[]           @relation("RevieweeReviews")
  sessions           UserSession[]
  notifications      Notification[]
  deviceTokens       DeviceToken[]

  @@index([neighborhood, city, state])
  @@index([createdAt])
  @@map("users")
}

model Listing {
  id            String           @id @default(cuid())
  sellerId      String           @map("seller_id")
  title         String
  description   String
  price         Decimal          @db.Decimal(10, 2)
  isFree        Boolean          @default(false) @map("is_free")
  isNegotiable  Boolean          @default(true) @map("is_negotiable")
  condition     ListingCondition
  category      ListingCategory
  neighborhood  String?
  city          String?
  state         String?
  latitude      Float?
  longitude     Float?
  status        ListingStatus    @default(ACTIVE)
  viewCount     Int              @default(0) @map("view_count")
  likeCount     Int              @default(0) @map("like_count")
  chatCount     Int              @default(0) @map("chat_count")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  // Relations
  seller        User             @relation("SellerListings", fields: [sellerId], references: [id], onDelete: Cascade)
  images        ListingImage[]
  offers        Offer[]
  conversations Conversation[]
  likes         Like[]
  reviews       Review[]

  @@index([sellerId])
  @@index([category, status])
  @@index([status, createdAt])
  @@index([city, state, status])
  @@index([latitude, longitude])
  @@index([price])
  @@map("listings")
}

model ListingImage {
  id           String   @id @default(cuid())
  listingId    String   @map("listing_id")
  url          String
  thumbnailUrl String?  @map("thumbnail_url")
  order        Int      @default(0)
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId, order])
  @@map("listing_images")
}

model Offer {
  id            String      @id @default(cuid())
  listingId     String      @map("listing_id")
  buyerId       String      @map("buyer_id")
  sellerId      String      @map("seller_id")
  amount        Decimal     @db.Decimal(10, 2)
  message       String?
  status        OfferStatus @default(PENDING)
  parentOfferId String?     @map("parent_offer_id")
  expiresAt     DateTime?   @map("expires_at")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  // Relations
  listing     Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  buyer       User     @relation("BuyerOffers", fields: [buyerId], references: [id], onDelete: Cascade)
  seller      User     @relation("SellerOffers", fields: [sellerId], references: [id], onDelete: Cascade)
  parentOffer Offer?   @relation("CounterOffers", fields: [parentOfferId], references: [id])
  counterOffers Offer[] @relation("CounterOffers")

  @@index([listingId, status])
  @@index([buyerId, status])
  @@index([sellerId, status])
  @@index([createdAt])
  @@map("offers")
}

model Conversation {
  id            String    @id @default(cuid())
  listingId     String    @map("listing_id")
  buyerId       String    @map("buyer_id")
  sellerId      String    @map("seller_id")
  lastMessageAt DateTime? @map("last_message_at")
  createdAt     DateTime  @default(now()) @map("created_at")

  // Relations
  listing  Listing   @relation(fields: [listingId], references: [id], onDelete: Cascade)
  buyer    User      @relation("BuyerConversations", fields: [buyerId], references: [id], onDelete: Cascade)
  seller   User      @relation("SellerConversations", fields: [sellerId], references: [id], onDelete: Cascade)
  messages Message[]

  @@unique([listingId, buyerId, sellerId])
  @@index([buyerId, lastMessageAt(sort: Desc)])
  @@index([sellerId, lastMessageAt(sort: Desc)])
  @@map("conversations")
}

model Message {
  id             String      @id @default(cuid())
  conversationId String      @map("conversation_id")
  senderId       String      @map("sender_id")
  content        String
  type           MessageType @default(TEXT)
  readAt         DateTime?   @map("read_at")
  createdAt      DateTime    @default(now()) @map("created_at")

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt(sort: Desc)])
  @@index([senderId])
  @@map("messages")
}

model Community {
  id          String        @id @default(cuid())
  name        String
  slug        String        @unique
  description String?
  type        CommunityType @default(NEIGHBORHOOD)
  icon        String?
  coverUrl    String?       @map("cover_url")
  memberCount Int           @default(0) @map("member_count")
  isActive    Boolean       @default(true) @map("is_active")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  members CommunityMember[]

  @@index([type, isActive])
  @@index([slug])
  @@map("communities")
}

model CommunityMember {
  id          String        @id @default(cuid())
  communityId String        @map("community_id")
  userId      String        @map("user_id")
  role        CommunityRole @default(MEMBER)
  joinedAt    DateTime      @default(now()) @map("joined_at")

  // Relations
  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([communityId, userId])
  @@index([userId])
  @@map("community_members")
}

model Like {
  userId    String   @map("user_id")
  listingId String   @map("listing_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@id([userId, listingId])
  @@index([listingId])
  @@map("likes")
}

model Review {
  id         String   @id @default(cuid())
  reviewerId String   @map("reviewer_id")
  revieweeId String   @map("reviewee_id")
  listingId  String?  @map("listing_id")
  rating     Int
  content    String?
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  reviewer User     @relation("ReviewerReviews", fields: [reviewerId], references: [id], onDelete: Cascade)
  reviewee User     @relation("RevieweeReviews", fields: [revieweeId], references: [id], onDelete: Cascade)
  listing  Listing? @relation(fields: [listingId], references: [id], onDelete: SetNull)

  @@unique([reviewerId, revieweeId, listingId])
  @@index([revieweeId, createdAt(sort: Desc)])
  @@map("reviews")
}

model UserSession {
  id               String   @id @default(cuid())
  userId           String   @map("user_id")
  refreshTokenHash String   @map("refresh_token_hash")
  deviceType       String?  @map("device_type")
  ipAddress        String?  @map("ip_address")
  userAgent        String?  @map("user_agent")
  expiresAt        DateTime @map("expires_at")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshTokenHash])
  @@index([expiresAt])
  @@map("user_sessions")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String           @map("user_id")
  type      NotificationType
  title     String
  body      String
  data      Json?
  readAt    DateTime?        @map("read_at")
  createdAt DateTime         @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, readAt, createdAt(sort: Desc)])
  @@map("notifications")
}

model DeviceToken {
  id        String         @id @default(cuid())
  userId    String         @map("user_id")
  token     String         @unique
  platform  DevicePlatform
  createdAt DateTime       @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("device_tokens")
}
